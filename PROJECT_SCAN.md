# GBA_MiSTer Project Scan

Summary of the codebase structure, key modules, and dependencies for porting or building.

---

## 1. Top-level hierarchy

```
GBA.qpf (Quartus project)
  └── sys/sys.tcl, sys_analog.tcl, sys.qip
  └── files.qip
  └── GBA.qsf, GBA.sdc

Top-level entity: sys_top (sys/sys_top.v)
  └── emu (GBA.sv)  ← "core" wrapper: clocks, HPS, memory, video, audio, OSD
        ├── pll (rtl/pll.v)           ← Altera PLL: 50 MHz → ~100.66 MHz, ~50.33 MHz
        ├── hps_io (sys/hps_io.sv)    ← MiSTer ARM HPS: status, joystick, SD, OSD, ROM load
        ├── sdram (rtl/sdram.sv)      ← SDRAM controller (3 channels: ROM, bus, save)
        ├── ddram (rtl/ddram.sv)      ← DDR3 wrapper (DE10-Nano HPS/fpga bridge)
        ├── savestate_ui (rtl/savestate_ui.sv)
        ├── video_mixer, video_freak (sys/)
        └── gba_top (rtl/gba_top.vhd) ← Actual GBA core (VHDL)
```

- **Target platform**: Intel Cyclone V DE10-Nano (MiSTer); device `5CSEBA6U23I7`.
- **Build**: Quartus; file list is in `files.qip`, `sys/sys.qip`, `rtl/gba.qip`, `rtl/mem.qip`, and QIP references.

---

## 2. Entry points and file lists

| File | Purpose |
|------|--------|
| **files.qip** | References: `rtl/gba.qip`, `rtl/mem.qip`, `rtl/sdram.sv`, `rtl/ddram.sv`, `rtl/savestate_ui.sv`, `GBA.sv` |
| **sys/sys.qip** | sys_top.v, sys_top.sdc, ascal.vhd, pll_hdmi*, video_*, osd, audio, i2c, hps_io, sd_card, etc. |
| **rtl/gba.qip** | All GBA core VHDL (gba_top, gba_cpu, gba_gpu, gba_dma, reggba_*, SyncRam*, cache, etc.) |
| **rtl/mem.qip** | SyncFifo, SyncRam, SyncRamDual, SyncRamDualNotPow2, SyncRamDualByteEnable |
| **GBA.qsf** | Top = sys_top, MISTER_FB=1, sources sys/sys.tcl, sys/sys_analog.tcl, files.qip |

`build_id.v` is generated by `sys/build_id.tcl` (Quartus pre-flow script) and included in `GBA.sv`; it defines `BUILD_DATE`.

---

## 3. GBA.sv (emu module) – interface and dependencies

### Inputs/Outputs (summary)

- **Clocks**: `CLK_50M` in → PLL → `clk_sys`, `CLK_VIDEO`; `CLK_AUDIO` (24.576 MHz) for audio.
- **Reset**: `RESET`; internal reset also from buttons, status, cart_download, bk_loading.
- **HPS**: `HPS_BUS` (49 bits inout) → `hps_io`: ARM I/O, OSD, ROM load, status, joystick, SD, etc.
- **Video**: VGA (R/G/B/HS/VS/DE/F1/SL), HDMI (WIDTH/HEIGHT, FREEZE/BLACKOUT/BOB_DEINT), optional framebuffer (MISTER_FB).
- **Audio**: `AUDIO_L`, `AUDIO_R`, `AUDIO_S`, `AUDIO_MIX`.
- **Memory**: `DDRAM_*` (DDR3 via HPS), `SDRAM_*` (direct SDRAM chip).
- **Storage**: `SD_*` (SPI SD).
- **Other**: `LED_USER/POWER/DISK`, `BUTTONS`, `ADC_BUS`, UART, USER I/O, `OSD_STATUS`.

### Key submodules used by emu

| Module | Location | Role |
|--------|----------|------|
| **pll** | rtl/pll.v + rtl/pll/pll_0002.v | Altera PLL: 50 MHz → outclk_0 (~100.66 MHz), outclk_1 (~50.33 MHz). **Altera-specific.** |
| **hps_io** | sys/hps_io.sv | Status, joystick, PS2, SD/ioctl, gamma, RTC. Talks to ARM over HPS_BUS. **MiSTer-specific.** |
| **sdram** | rtl/sdram.sv | Multi-channel SDRAM controller; physical SDRAM pins. **Platform-agnostic RTL.** |
| **ddram** | rtl/ddram.sv | Wraps DE10-Nano DDR3 (HPS bridge); exposes same channel-style interface. **MiSTer/DE10-specific.** |
| **savestate_ui** | rtl/savestate_ui.sv | Savestate hotkeys / UI. |
| **video_mixer** | sys/video_mixer.sv | Combines core video + OSD. |
| **video_freak** | sys/video_freak.sv | Resolution/timing. |
| **gba_top** | rtl/gba_top.vhd | GBA CPU/GPU/sound/memory; VHDL. **Core logic; platform-agnostic.** |

---

## 4. GBA core (rtl/) – VHDL

- **Top**: `gba_top.vhd` (entity `gba_top`).
- **Clock**: `clk100` (same as `clk_sys` in GBA.sv, ~100 MHz from PLL).
- **Memory interfaces**:
  - `sdram_read_ena/done/addr/data`, `sdram_second_dword` → ROM reads (via sdram/ddram in GBA.sv).
  - `bus_out_*` (Din/Dout/Adr/rnw/ena/done) → WRam/SRAM/Flash/EEPROM (also serviced by sdram/ddram).
  - `SAVE_out_*` → savestate (ddram ch4).
- **Inputs**: BIOS write, settings (turbo, rewind, RTC, cheats, etc.), keys (KeyA/B, Start, D-pad, etc.), savestate slot/save/load.
- **Outputs**: Pixel (addr/data/we), optional largeimg/framebuffer, sound L/R.

**rtl/gba.qip** lists all VHDL files (gba_*.vhd, reggba_*.vhd, proc_bus_gba.vhd, cache.vhd, SyncRam*.vhd, etc.). **rtl/mem.qip** lists shared RAM primitives. No Altera-only constructs in the core itself; Altera usage is in `rtl/pll.v` and in some SyncRam* (optional Cyclone-5 variants).

---

## 5. sys_top.v – board mapping (DE10-Nano)

- **Clocks**: `FPGA_CLK1_50`, `FPGA_CLK2_50`, `FPGA_CLK3_50` (50 MHz).
- **Video**: HDMI (I2C, I2S, TX_CLK/DE/D/HS/VS), VGA (R/G/B/HS/VS), optional dual SDRAM path.
- **SDRAM**: 13-bit A, 16-bit DQ, BA, nCS/nWE/nRAS/nCAS, CLK, CKE (pin assignments in sys.tcl).
- **I/O**: Buttons (BTN_USER, BTN_OSD, BTN_RESET), switches (SW), LEDs (LED), SD (SPI + SDIO path), USER_IO, ADC, I2C (mcp23009), etc.

`emu` is instantiated with:
- `CLK_50M` = `FPGA_CLK2_50`
- DDRAM_* connected to internal `ram_*` (from HPS/fpga bridge)
- SDRAM_* connected to physical SDRAM pins
- Video/audio/buttons/OSD from sys_top’s HDMI/VGA/audio/OSD logic

---

## 6. Memory architecture (in GBA.sv)

- **ROM/cart**: Served by either **sdram** (ch1/ch2) or **ddram** (ch1/ch2). `sdram_en` selects SDRAM vs DDRAM; if no SDRAM or small SDRAM, DDRAM is used.
- **Bus (WRam/SRAM/Flash/EEPROM)**: Same choice — sdram ch2 or ddram ch2.
- **Save (bram)**: sdram ch3 or ddram ch3.
- **Savestate**: ddram ch4 only.
- **Framebuffer (2x/HDMI)**: ddram ch5.

So for a minimal run you need at least one of: (1) SDRAM, or (2) a DDRAM-like interface (e.g. another RAM controller that matches ddram’s channel API).

---

## 7. Altera / MiSTer-specific pieces

- **rtl/pll.v**, **rtl/pll/pll_0002.v**: Altera PLL; must be replaced or bypassed on Xilinx (e.g. 50 MHz from 100 MHz + Xilinx MMCM or simple divider).
- **sys/pll_hdmi.v**, **pll_audio.v**, **pll_cfg/** : Altera PLLs for HDMI and audio.
- **sys/hps_io.sv**: ARM HPS_BUS protocol; on a non-MiSTer board needs a stub that drives `status`, `buttons`, `joystick_*`, `ioctl_*`, etc. with safe defaults (and no real ROM load unless you add another path).
- **rtl/ddram.sv**: DE10-Nano DDR3 bridge; on AUP-ZU3 you’d need a different backend (e.g. BRAM, or ZU3 PS DDR via AXI, or external SDRAM) that implements the same channel interface.
- **sys_top.v**, **sys/sys.tcl**: Pinout and device for DE10-Nano; for AUP-ZU3 you need a new top and XDC.

---

## 8. Simulation (sim/)

- **sim/readme.md**: Describes ModelSim flow; BIOS, ROM loading via Lua scripts; DDR-only path; no HPS/top-level cart download.
- Test scripts in **sim/tests/*.lua** (e.g. gba_bootrom.lua).
- **sim/src/tb/**: Testbenches (tb.vhd, ddram, framebuffer, etc.), **sim/src/mem/**, **sim/src/rs232/**, **sim/src/procbus/**.

---

## 9. What’s needed to run on AUP-ZU3 (Vivado)

1. **New top** (e.g. `zu3_top.sv`): 100 MHz (or 50 MHz) clock from board, RESET, and connection to `emu` with all MiSTer-specific ports stubbed or adapted.
2. **Clock**: Replace `pll` with a Xilinx-compatible block (e.g. clock wizard or divider) producing ~50 MHz and ~100 MHz (or whatever `clk_sys` expects).
3. **hps_io**: Stub module with same port list, driving default `status`, `buttons`, `joystick_*`, `ioctl_*` (no real ROM load unless you add SD or other loader).
4. **Memory**: Either:
   - Use existing **sdram.sv** and add AUP-ZU3 SDRAM pins to XDC (if the board has PL SDRAM), or
   - Replace **ddram** with a BRAM (or other) backend that implements the same ch1–ch5 interface (and possibly only ch1/ch2/ch3 for a minimal boot).
5. **build_id.v**: Generate (e.g. `BUILD_DATE`) by script or static file so `GBA.sv` compiles.
6. **Vivado project**: New project or Makefile+Tcl; add all sources from files.qip + sys (only the ones emu actually uses), rtl/gba.qip, rtl/mem.qip; exclude Altera-only blocks and replace with Xilinx/stub equivalents.
7. **XDC**: AUP-ZU3 pins for clock, LEDs, buttons, switches, and if used SDRAM/video/audio.

This scan gives the map; the actual port is a separate step (creating zu3_top, stubs, and Vivado flow).
